<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="refresh" content="0; url=/comic.html">
  <title>MERC Online</title>
  <link rel="canonical" href="/comic.html">
</head>

<body>
  <header>
    <div class="wrap">
      <strong>MERC Online</strong>
      <nav style="float:right">
        <a class="btn" href="/comic.html">Comic</a>
        <a class="btn" href="#play">Play</a>
        <a class="btn" href="#rewards">Rewards</a>
      </nav>
      <div style="clear:both"></div>
    </div>
  </header>
  <main class="wrap">
    <div class="grid">
      <div class="card">
        <h2>Play (embedded)</h2>
        <p>This iframe will load your Godot export. For now it hits the placeholder /play build.</p>
        <iframe id="play" src="./play/index.html"></iframe>
      </div>
      <div class="card" id="rewards">
        <h2>Chapter 1 Reward</h2>
        <p>Simulate the end-of-chapter token flow:</p>
        <button class="btn" onclick="getToken()">Get Claim Token</button>
        <button class="btn" onclick="claim()">Claim Reward</button>
        <pre id="out"></pre>
      </div>
    </div>
  </main>
  <footer class="wrap">Â© MERC</footer>
  <script>
    const API = (path) => (location.origin.includes('localhost') ? 'http://localhost:2567' : '') + path;
    let authJWT = null;
    let claimToken = null;

    async function devLogin() {
      // generate a random guest ID for now
      const guestId = "guest_" + Date.now() + "_" + Math.floor(Math.random() * 1000);

      const r = await fetch(API('/auth/dev-login'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: guestId, name: 'Guest User' })
      });

      if (!r.ok) {
        log('Login failed: ' + r.status);
        return;
      }
      const data = await r.json();
      authJWT = data.token;
      log(`JWT acquired for ${guestId}`);
    }

    async function getToken() {
      if (!authJWT) await devLogin();
      const r = await fetch(API('/rewards/token?chapter=1'), { headers: { 'Authorization': 'Bearer ' + authJWT } });
      const data = await r.json(); claimToken = data.token; log('Claim token: ' + claimToken);
    }
    async function claim() {
      if (!authJWT) await devLogin();
      if (!claimToken) await getToken();
      const r = await fetch(API('/rewards/claim'), { method: 'POST', headers: { 'Authorization': 'Bearer ' + authJWT, 'Content-Type': 'application/json' }, body: JSON.stringify({ token: claimToken }) });
      const data = await r.json(); log(JSON.stringify(data, null, 2));
    }
    function log(s) { document.getElementById('out').textContent = s; }
  </script>
</body>

</html>